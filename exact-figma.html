<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egg OS - Exact Figma Match</title>
    <style>
        /* Font declarations */
        @font-face {
            font-family: "Cash Sans-Medium";
            src: local("SF Pro Text Medium"), local("SF Pro Display Medium"), local("Helvetica Neue Medium"), local("Helvetica"), local("Arial"), sans-serif;
            font-weight: 500;
        }
        
        @font-face {
            font-family: "Cash Sans-Semibold";
            src: local("SF Pro Text Semibold"), local("SF Pro Display Semibold"), local("Helvetica Neue Bold"), local("Helvetica Bold"), local("Arial Bold"), sans-serif;
            font-weight: 600;
        }
        
        /* Reset and base styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: "Cash Sans-Medium", Helvetica;
            font-size: 18px;
            line-height: normal;
            letter-spacing: 0;
            background-color: #f5f5f7;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* Remove all font declarations from individual components as they should inherit from body */
        
        
        /* Content styles */
        .content {
          align-items: flex-start;
          display: flex;
          flex-direction: column;
          gap: 30px;
          height: 100vh;
          position: relative;
          width: 100%;
          max-width: 2500px;
          margin: 0 auto;
          padding-bottom: var(--egg-tray-height);
        }

        /* Chat container */
        :root {
          --egg-tray-height: 200px;
        }

        .content .chat {
          align-items: center;
          align-self: stretch;
          display: flex;
          flex: 1;
          flex-direction: column;
          flex-grow: 1;
          gap: 15px;
          overflow-y: scroll;
          padding: 30px;
          position: relative;
          width: 100%;
        }

        .content .chat::after {
          content: '';
          display: block;
          height: var(--egg-tray-height);
          flex-shrink: 0;
        }

        .content .chat::-webkit-scrollbar {
          display: none;
          width: 0;
        }

        .content .text-wrapper {
          align-self: stretch;
          color: #0000004c;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
          height: 48px;
          letter-spacing: 0;
          line-height: normal;
          position: relative;
          text-align: center;
        }

        /* Message containers */
        .frame-wrapper {
          align-self: stretch;
          position: relative;
          width: 100%;
          display: flex;
        }

        .frame-wrapper.right {
          justify-content: flex-end;
        }

        /* Message bubbles */
        .message-bubble {
          align-items: center;
          border-radius: 100px;
          box-shadow: inset 0px 1px 1px rgba(255, 255, 255, 0.25), 0px 5px 15px rgba(0, 0, 0, 0.15);
          display: inline-flex;
          gap: 10px;
          padding: 18px 30px;
          position: relative;
        }

        .message-bubble .text {
          color: inherit;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
          letter-spacing: 0;
          line-height: normal;
          white-space: nowrap;
        }

        /* Song suggestion bubbles (special styling) */
        .message-bubble.assistant.song-suggestion {
          padding: 30px;
          display: flex;
          align-items: center;
          gap: 30px;
          height: auto;
          width: 320px;
          border-radius: 30px !important;
          background-color: #000000;
        }

        .message-bubble.song-suggestion .suggestion-text {
          color: inherit;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
          letter-spacing: 0;
          line-height: normal;
          white-space: nowrap;
        }

        .message-bubble.song-suggestion .play {
          height: 48px;
          width: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          margin-left: auto;
          background-color: rgba(255, 255, 255, 0.1);
          border-radius: 24px;
          flex-shrink: 0;
          padding: 12px;
        }

        .message-bubble.song-suggestion .play img {
          height: 24px;
          width: 24px;
          display: block;
        }

        .message-bubble.assistant {
          background-color: #000000;
          color: #ffffff;
        }

        .message-bubble.user {
          background-color: #ffffff;
          color: #000000;
        }

        /* Weather egg component */
        .egg-response {
          align-items: center;
          align-self: stretch;
          display: flex;
          gap: 30px;
          position: relative;
          width: 100%;
          justify-content: flex-start;
          margin: 15px 0;
        }

        .weather-egg {
          background-color: #4cbeff;
          border-radius: 30px;
          box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.15), inset 0px 1px 1px rgba(255, 255, 255, 0.25);
          height: 200px;
          overflow: hidden;
          position: relative;
          width: 320px;
        }

        .weather-egg .frame {
          align-items: flex-start;
          display: flex;
          justify-content: space-between;
          left: 30px;
          position: absolute;
          top: 30px;
          width: 260px;
        }

        .weather-egg .location-info {
          align-items: flex-start;
          align-self: stretch;
          display: inline-flex;
          flex: 0 0 auto;
          flex-direction: column;
          justify-content: space-between;
          position: relative;
        }

        .weather-egg .location {
          align-self: stretch;
          color: #000000;
          font-family: "Cash Sans-Semibold", Helvetica;
          font-size: 18px;
          font-weight: 700;
          letter-spacing: 0;
          line-height: normal;
          margin-top: -1.00px;
          position: relative;
        }

        .weather-egg .condition {
          align-self: stretch;
          color: #000000;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
          letter-spacing: 0;
          line-height: normal;
          position: relative;
        }

        .weather-egg .more-button {
          align-items: center;
          background-color: rgba(0, 0, 0, 0.05);
          border-radius: 24px;
          display: flex;
          gap: 10px;
          height: 48px;
          padding: 12px;
          position: relative;
          width: 48px;
        }

        .weather-egg .icons-dots {
          height: 24px;
          position: relative;
          width: 24px;
        }

        .weather-egg .frame-2 {
          align-items: flex-end;
          display: flex;
          justify-content: space-between;
          left: 30px;
          position: absolute;
          bottom: 30px;
          width: 260px;
        }

        .weather-egg .temperature {
          color: #000000;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 64px;
          font-weight: 500;
          letter-spacing: 0;
          line-height: normal;
          position: relative;
          white-space: nowrap;
        }

        .weather-egg .icons-sun {
          height: 48px;
          width: 48px;
          position: relative;
          margin-bottom: 8px;
        }

        /* Egg tray styles */
        .egg-tray {
          -webkit-backdrop-filter: blur(25px) brightness(100%);
          backdrop-filter: blur(25px) brightness(100%);
          background-color: rgba(255, 255, 255, 0.3);
          border-radius: 60px 60px 0px 0px;
          box-shadow: inset 0px 1px 1px rgba(255, 255, 255, 0.25), 0px 4px 50px rgba(0, 0, 0, 0.15);
          display: flex;
          flex-direction: column;
          gap: 15px;
          padding: 30px;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100%;
          max-width: 2500px;
          margin: 0 auto;
          z-index: 100;
        }

        .egg-tray .input-frame {
          align-items: center;
          align-self: stretch;
          background-color: #ffffff;
          border-radius: 100px;
          box-shadow: inset 0px 1px 1px rgba(255, 255, 255, 0.25), 0px 5px 15px rgba(0, 0, 0, 0.15);
          display: flex;
          gap: 10px;
          height: 60px;
          justify-content: center;
          padding: 0 6px 0 30px;
          position: relative;
          width: 100%;
        }

        .egg-tray .input-text {
          align-self: stretch;
          color: #000000;
          flex: 1;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
          letter-spacing: 0;
          line-height: normal;
          position: relative;
          white-space: nowrap;
          background: none;
          border: none;
          outline: none;
          width: 100%;
          height: 100%;
          padding: 0;
        }

        .egg-tray .input-text::placeholder {
          color: rgba(0, 0, 0, 0.5);
        }

        .egg-tray .button-wrapper {
          align-items: center;
          background-color: rgba(0, 0, 0, 0.05);
          border-radius: 100px;
          display: inline-flex;
          gap: 6px;
          margin: -17px 0;
          position: relative;
        }

        .egg-tray .mic-button {
          align-items: center;
          border-radius: 24px;
          display: flex;
          gap: 10px;
          height: 48px;
          padding: 12px;
          position: relative;
          width: 48px;
          cursor: pointer;
        }

        .egg-tray .send-button {
          all: unset;
          align-items: center;
          background-color: rgba(0, 0, 0, 0.05);
          border-radius: 100px;
          box-sizing: border-box;
          display: flex;
          margin: -17px 0;
          padding: 0 20px;
          height: 48px;
          justify-content: center;
          cursor: pointer;
          color: #000000;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
        }

        .egg-tray .status-bar {
          align-items: center;
          align-self: stretch;
          display: flex;
          gap: 30px;
          justify-content: center;
          padding: 0px 30px;
          position: relative;
          width: 100%;
        }

        .egg-tray .user-info {
          align-items: center;
          display: flex;
          flex: 1;
          gap: 15px;
          position: relative;
          height: 48px;
        }

        .egg-tray .user-avatar {
          height: 24px;
          width: 24px;
          border-radius: 50%;
          background-color: #ccc;
        }

        .egg-tray .user-name {
          color: #000000;
          flex: 1;
          font-family: "Cash Sans-Semibold", Helvetica;
          font-size: 18px;
          font-weight: 400;
          letter-spacing: 0;
          line-height: normal;
          position: relative;
        }

        .egg-tray .divider {
          flex: 1;
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .egg-tray .divider-line {
          background-color: #000000;
          border-radius: 7px;
          height: 8px;
          width: 50px;
        }

        .egg-tray .status-info {
          align-items: center;
          display: flex;
          flex: 1;
          gap: 15px;
          justify-content: flex-end;
        }

        .egg-tray .time {
          color: #000000;
          font-family: "Cash Sans-Semibold", Helvetica;
          font-size: 18px;
          font-weight: 400;
          letter-spacing: 0;
          line-height: normal;
          text-align: right;
        }


        .egg-tray .status-indicator {
          background-color: #0fea21;
          border-radius: 12px;
          height: 24px;
          width: 24px;
        }

        /* Chat inline egg responses */
        .chat .egg-response {
          display: flex;
          width: 100%;
          justify-content: flex-start;
          /* Remove margin since parent chat has gap: 15px */
          margin: 0;
        }

        /* Egg tray collection */
        .egg-tray .egg-collection {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: center;
          gap: 30px;
          width: 100%;
          max-width: 2500px;
          margin: 0 auto;
        }

        /* Tray egg container */
        .tray-egg {
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .eggs-music {
          background-color: rgba(0, 0, 0, 0.1);
          background-position: center;
          background-size: cover;
          border-radius: 30px;
          box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.15), inset 0px 1px 1px rgba(255, 255, 255, 0.25);
          height: 200px;
          overflow: hidden;
          width: 320px;
          position: relative;
        }

        .eggs-music::before {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: inherit;
          background-position: inherit;
          background-size: inherit;
          filter: blur(50px);
          z-index: 1;
        }

        .eggs-music::after {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(255, 255, 255, 0.3);
          z-index: 2;
        }

        .eggs-music .overlap-group {
          position: relative;
          height: 100%;
          z-index: 3;
        }

        .eggs-music .overlap-group {
          -webkit-backdrop-filter: blur(25px) brightness(100%);
          backdrop-filter: blur(25px) brightness(100%);
          background-color: rgba(255, 255, 255, 0.3);
          height: 200px;
          position: relative;
        }

        .eggs-music .frame {
          align-items: flex-start;
          display: flex;
          justify-content: space-between;
          left: 30px;
          position: absolute;
          top: 30px;
          width: 260px;
        }

        .eggs-music .info {
          align-items: flex-start;
          display: inline-flex;
          flex-direction: column;
          justify-content: space-between;
          position: relative;
        }

        .eggs-music .song-title {
          align-self: stretch;
          color: #000000;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 700;
          letter-spacing: 0;
          line-height: normal;
          margin-top: -1.00px;
          position: relative;
        }

        .eggs-music .artist {
          align-self: stretch;
          color: #000000;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
          letter-spacing: 0;
          line-height: normal;
          position: relative;
        }

        .eggs-music .more-button {
          align-items: center;
          background-color: rgba(0, 0, 0, 0.05);
          border-radius: 24px;
          display: flex;
          gap: 10px;
          height: 48px;
          padding: 12px;
          position: relative;
          width: 48px;
        }

        .eggs-music .icons-dots {
          height: 24px;
          position: relative;
          width: 24px;
        }

        .eggs-music .frame-2 {
          align-items: center;
          display: flex;
          gap: 30px;
          left: 30px;
          position: absolute;
          top: 122px;
          width: 260px;
        }

        .eggs-music .album-artwork {
          height: 48px;
          width: 48px;
          object-fit: cover;
          position: relative;
          border-radius: 4px;
        }

        .eggs-music .timeline {
          background-color: rgba(0, 0, 0, 0.15);
          border-radius: 3px;
          flex: 1;
          flex-grow: 1;
          height: 6px;
          position: relative;
        }

        .eggs-music .rectangle {
          background-color: #000000;
          border-radius: 3px;
          height: 6px;
          width: 18px;
        }

        .eggs-music .play {
          align-items: center;
          display: flex;
          justify-content: center;
          background-color: rgba(0, 0, 0, 0.05);
          border-radius: 24px;
          height: 48px;
          width: 48px;
          position: relative;
        }

        .eggs-music .play img {
          height: 24px;
          width: 24px;
        }

        .song-suggestion {
          align-items: center;
          background-color: #000000;
          border-radius: 100px;
          display: inline-flex;
          gap: 10px;
          height: 60px;
          padding: 6px 6px 6px 30px;
          position: relative;
        }

        .song-suggestion .suggestion-image {
          height: 48px;
          margin-bottom: -17.00px;
          margin-top: -17.00px;
          object-fit: cover;
          position: relative;
          width: 48px;
        }

        .song-suggestion .suggestion-text {
          color: #ffffff;
          font-family: "Cash Sans-Medium", Helvetica;
          font-size: 18px;
          font-weight: 500;
          letter-spacing: 0;
          line-height: normal;
          white-space: nowrap;
        }

        .song-suggestion .icons-play {
          flex: 0 0 auto;
          margin-bottom: -5.00px;
          margin-top: -5.00px;
          position: relative;
          width: 24px;
          height: 24px;
        }

        .song-suggestion .play {
          align-items: center;
          display: flex;
          justify-content: center;
          background-color: rgba(255, 255, 255, 0.15);
          border-radius: 24px;
          height: 48px;
          width: 48px;
          flex-shrink: 0;
          padding: 12px;
        }

        .song-suggestion .play img {
          height: 24px;
          width: 24px;
          display: block;
        }

        .suggestions-wrapper {
          display: flex;
          flex-direction: column;
          gap: 15px;
          width: 100%;
          padding: 15px 0 0 0;
        }

        /* Custom styles for suggestions inside egg-response */
        .egg-response .suggestions-wrapper {
          margin: 0;
        }

        .egg-response .suggestions-wrapper .frame-wrapper {
          margin: 0;
        }
    </style>
</head>
<body>
    <div class="content">
      <div class="chat">
        <div class="text-wrapper">9:24 PM</div>
        <!-- Messages will be added here dynamically -->
      </div>

      <div class="egg-tray">
        <div class="input-frame">
          <input type="text" class="input-text" placeholder="ask for anything">

          <div class="button-wrapper">
            <div class="mic-button">
              <img src="assets/icons/mic.svg" alt="Microphone" width="24" height="24">
            </div>
          </div>

          <button class="send-button" onclick="handleSend()">
            <div class="text">send</div>
          </button>
        </div>

        <div class="status-bar">
          <div class="user-info">
            <img class="user-avatar" src="assets/robert_avatar.jpg" alt="rsa">
            <div class="user-name">rsa</div>
          </div>

          <div class="divider">
            <div class="divider-line"></div>
          </div>

          <div class="status-info">
            <div class="time">9:28 PM</div>
            <div class="status-indicator"></div>
          </div>
        </div>

        <div class="egg-collection">
          <!-- Eggs will be added here dynamically -->
        </div>
      </div>
    </div>

    <script>
      // State management
      const state = {
        messages: [],
        eggs: [],
        isProcessing: false,
        currentMusic: null
      };

      // Music API functions
      async function searchMusicPreviews(term, limit = 10) {
        try {
          console.log(`Searching for music: ${term}`);
          const timestamp = new Date().getTime();
          const apiUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=music&limit=${limit}&t=${timestamp}`;
          console.log(`API URL: ${apiUrl}`);
          
          const response = await fetch(apiUrl, { 
            mode: 'cors',
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error(`iTunes API error: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('iTunes API response:', data);
          
          return data.results.map(item => {
            let albumArt = item.artworkUrl100 || null;
            if (albumArt) {
              albumArt = albumArt.replace('100x100bb', '600x600bb');
            }
            
            return {
              id: item.trackId,
              title: item.trackName || 'Unknown Title',
              artist: item.artistName || 'Unknown Artist',
              album: item.collectionName || 'Unknown Album',
              albumArt: albumArt,
              previewUrl: item.previewUrl
            };
          });
        } catch (error) {
          console.error('Error searching music previews:', error);
          return [];
        }
      }

      // Weather functions using real APIs
      // Use a CORS proxy for API requests
      const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
      
      // Weather API configuration
      const config = {
        openweatherKey: '13d0248755953db176e513edacfe3629',
        defaultLocation: {
          city: "Kilauea",
          region: "Hawaii",
          country: "US",
          latitude: 22.2121,
          longitude: -159.4134
        }
      };

      // Get weather data using an alternative API that doesn't require a proxy
      async function getWeatherAlternative(lat, lon) {
        try {
          const url = `https://api.weatherapi.com/v1/current.json?key=9b249a2457674492896160441241703&q=${lat},${lon}&aqi=no`;
          const response = await fetch(url);
          const data = await response.json();
          
          if (!response.ok) throw new Error('Weather API failed');
          
          return {
            condition: data.current.condition.text.toUpperCase(),
            temperature: `${Math.round(data.current.temp_f)}°F`,
            icon: getWeatherIcon(data.current.condition.text)
          };
        } catch (error) {
          console.error('Alternative weather API failed:', error);
          return null;
        }
      }

      // Map weather conditions to our icon set
      function getWeatherIcon(condition) {
        condition = condition.toLowerCase();
        if (condition.includes('sun') || condition.includes('clear')) return 'sun';
        if (condition.includes('rain') || condition.includes('drizzle')) return 'rain';
        if (condition.includes('snow') || condition.includes('sleet') || condition.includes('ice')) return 'snow';
        if (condition.includes('storm') || condition.includes('thunder')) return 'storm';
        if (condition.includes('cloud') || condition.includes('overcast') || condition.includes('fog') || condition.includes('mist')) return 'cloud';
        return 'sun';
      }
      
      async function getLocationFromIP() {
        try {
          // Try ipapi.co first
          const response = await fetch('https://ipapi.co/json/', {
            headers: {
              'Accept': 'application/json',
              'User-Agent': 'Mozilla/5.0'
            }
          });
          
          if (!response.ok) throw new Error('ipapi.co failed');
          
          const data = await response.json();
          return {
            city: data.city,
            region: data.region,
            country: data.country,
            latitude: data.latitude,
            longitude: data.longitude
          };
        } catch (firstError) {
          console.error('First location attempt failed:', firstError);
          
          try {
            // Try ip-api as fallback
            const fallbackResponse = await fetch('http://ip-api.com/json/');
            if (!fallbackResponse.ok) throw new Error('ip-api failed');
            
            const fallbackData = await fallbackResponse.json();
            return {
              city: fallbackData.city,
              region: fallbackData.regionName,
              country: fallbackData.country,
              latitude: fallbackData.lat,
              longitude: fallbackData.lon
            };
          } catch (secondError) {
            console.error('Fallback location attempt failed:', secondError);
            return config.defaultLocation;
          }
        }
      }

      async function getWeather(specificLocation = null) {
        try {
          // Get location either from parameter or IP
          let location = specificLocation || await getLocationFromIP();
          
          // Try WeatherAPI.com first (doesn't require proxy)
          const weatherData = await getWeatherAlternative(location.latitude, location.longitude);
          
          if (weatherData) {
            return {
              location: `${location.city}, ${location.region}`.toUpperCase(),
              ...weatherData
            };
          }
          
          // Fallback to OpenWeatherMap if WeatherAPI fails
          const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${location.latitude}&lon=${location.longitude}&appid=${config.openweatherKey}&units=imperial`;
          const response = await fetch(weatherUrl);
          
          if (!response.ok) {
            throw new Error('Both weather APIs failed');
          }
          
          const data = await response.json();
          
          return {
            location: `${location.city}, ${location.region}`.toUpperCase(),
            condition: data.weather[0].main.toUpperCase(),
            temperature: `${Math.round(data.main.temp)}°F`,
            icon: getWeatherIcon(data.weather[0].main)
          };
        } catch (error) {
          console.error('Error getting weather:', error);
          return {
            location: `${config.defaultLocation.city}, ${config.defaultLocation.region}`.toUpperCase(),
            condition: "SUNNY",
            temperature: "75°F",
            icon: "sun"
          };
        }
      }
      // Egg creation functions
      function createWeatherEgg(weatherData, isInTray = false) {
        const getWeatherIcon = (iconName) => {
          // Map our weather types to icon filenames
          const iconMap = {
            'sun': 'sun.svg',
            'cloud': 'cloud.svg',
            'rain': 'rain.svg',
            'snow': 'snow.svg',
            'storm': 'storm.svg'
          };
          return `assets/icons/${iconMap[iconName] || 'sun.svg'}`;
        };

        const template = `
          <div class="weather-egg">
            <div class="frame">
              <div class="location-info">
                <div class="location">${weatherData.location}</div>
                <div class="condition">${weatherData.condition}</div>
              </div>
              <div class="more-button">
                <img class="icons-dots" src="assets/icons/dots.svg" alt="More options">
              </div>
            </div>
            <div class="frame-2">
              <div class="temperature">${weatherData.temperature}</div>
              <img class="icons-sun" src="${getWeatherIcon(weatherData.icon)}" alt="Weather icon">
            </div>
          </div>
        `;

        const wrapper = document.createElement('div');
        wrapper.className = isInTray ? 'tray-egg' : 'egg-response';
        wrapper.innerHTML = template;
        return wrapper;
      }

      function createMusicEgg(musicData, isInTray = false) {
        const eggId = `music-${musicData.id}`;  // Using the track ID for uniqueness
        const template = `
          <div class="eggs-music" data-egg-id="${eggId}" style="background-image: url('${musicData.albumArt}')">
            <div class="overlap-group">
              <div class="frame">
                <div class="info">
                  <div class="song-title">${musicData.title.toUpperCase()}</div>
                  <div class="artist">${musicData.artist.toUpperCase()}</div>
                </div>
                <div class="more-button">
                  <img class="icons-dots" src="assets/icons/dots.svg" alt="More options">
                </div>
              </div>
              <div class="frame-2">
                <img class="album-artwork" src="${musicData.albumArt}" alt="Album artwork">
                <div class="timeline">
                  <div class="rectangle"></div>
                </div>
                <div class="play" onclick="toggleMusic('${musicData.previewUrl}')">
                  <img src="assets/icons/play.svg" alt="Play">
                </div>
              </div>
            </div>
          </div>
        `;

        const wrapper = document.createElement('div');
        wrapper.className = isInTray ? 'tray-egg' : 'egg-response';
        wrapper.innerHTML = template;

        // Start playing automatically if not in tray
        if (!isInTray) {
          setTimeout(() => {
            const playButton = wrapper.querySelector('.play');
            toggleMusic(musicData.previewUrl, playButton);
          }, 100);
        }

        return wrapper;
      }

      function addMusicWithSuggestions(data) {
        // First add the music egg
        const chatContainer = document.querySelector('.chat');
        const eggElement = createMusicEgg(data.result);
        chatContainer.appendChild(eggElement);

        // Then add suggestions from search results
        const suggestions = data.suggestions.map(result => ({
          id: result.id,
          title: `${result.artist} – ${result.title}`,
          image: result.albumArt,
          previewUrl: result.previewUrl
        }));

        suggestions.forEach(suggestion => {
          const suggestionElement = createMessageSuggestion(suggestion);
          chatContainer.appendChild(suggestionElement);
        });

        // Update the egg tray
        state.eggs.push({ type: 'music', data: data.result });
        updateEggTray();

        // Scroll to latest
        scrollToLatest();
      }

      // Audio handling
      let audioPlayer = null;

      function toggleMusic(previewUrl) {
        // Find all related play buttons (both in eggs and suggestions)
        const allPlayButtons = document.querySelectorAll('.play');
        const relevantButtons = Array.from(allPlayButtons).filter(btn => {
          const onclickAttr = btn.getAttribute('onclick');
          return onclickAttr && onclickAttr.includes(previewUrl);
        });

        function updatePlayButtons(isPaused) {
          const icon = isPaused ? 'play' : 'pause';
          relevantButtons.forEach(btn => {
            const img = btn.querySelector('img');
            if (img) {
              const inSuggestion = btn.closest('.song-suggestion') !== null;
              const suffix = inSuggestion ? '-white' : '';
              img.src = `assets/icons/${icon}${suffix}.svg`;
            }
          });
        }

        // Handle audio playback
        if (audioPlayer && audioPlayer.src === previewUrl) {
          if (audioPlayer.paused) {
            audioPlayer.play();
            updatePlayButtons(false);
          } else {
            audioPlayer.pause();
            updatePlayButtons(true);
          }
        } else {
          // If different track was playing, reset its buttons
          if (audioPlayer) {
            const oldUrl = audioPlayer.src;
            audioPlayer.pause();
            
            // Reset all play buttons
            const allButtons = document.querySelectorAll('.play');
            allButtons.forEach(btn => {
              const img = btn.querySelector('img');
              if (img) {
                const inSuggestion = btn.closest('.song-suggestion') !== null;
                const suffix = inSuggestion ? '-white' : '';
                img.src = `assets/icons/play${suffix}.svg`;
              }
            });
          }
          
          // Play new track
          audioPlayer = new Audio(previewUrl);
          audioPlayer.play();
          updatePlayButtons(false);
          
          audioPlayer.addEventListener('ended', () => {
            updatePlayButtons(true);
          });
        }
      }

      // Egg management
      function addEgg(egg, eggData) {
        if (egg === 'weather') {
          state.eggs.push({ type: egg, data: eggData });
          
          const chatContainer = document.querySelector('.chat');
          const eggElement = createWeatherEgg(eggData);
          chatContainer.appendChild(eggElement);
          scrollToLatest();

          // Update the egg tray
          updateEggTray();
        } else if (egg === 'music') {
          addMusicWithSuggestions(eggData);
        }
      }

      function updateEggTray() {
        const eggCollection = document.querySelector('.egg-collection');
        eggCollection.innerHTML = '';
        
        // Add the most recent eggs (limit to 2-3)
        state.eggs.slice(-2).forEach(egg => {
          const eggElement = egg.type === 'weather'
            ? createWeatherEgg(egg.data, true)  // Pass true for isInTray
            : createMusicEgg(egg.data, true);   // Pass true for isInTray
          eggCollection.appendChild(eggElement);
        });
      }

      // Scroll handling
      function scrollToBottom(container) {
        const scrollHeight = container.scrollHeight;
        const height = container.clientHeight;
        const maxScrollTop = scrollHeight - height;
        container.scrollTop = maxScrollTop;
      }

      // Scroll handling
      function scrollToLatest() {
        const chat = document.querySelector('.chat');
        const lastMessage = chat.lastElementChild;
        if (lastMessage) {
          // Scroll the last message to be just above the egg tray
          lastMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      // Message handling
      function createMessageElement(text, isUser = false) {
        const wrapper = document.createElement('div');
        wrapper.className = `frame-wrapper${isUser ? ' right' : ''}`;
        
        const bubble = document.createElement('div');
        bubble.className = `message-bubble${isUser ? ' user' : ' assistant'}`;
        
        const textDiv = document.createElement('div');
        textDiv.className = 'text';
        textDiv.textContent = text;
        
        bubble.appendChild(textDiv);
        wrapper.appendChild(bubble);
        return wrapper;
      }

      function createMessageSuggestion(suggestion) {
        const wrapper = document.createElement('div');
        wrapper.className = 'frame-wrapper';
        
        wrapper.innerHTML = `
          <div class="message-bubble assistant song-suggestion">
            <div class="suggestion-info">
              <div class="suggestion-title">${suggestion.title.split(' – ')[0].toUpperCase()}</div>
              <div class="suggestion-artist">${suggestion.title.split(' – ')[1].toUpperCase()}</div>
            </div>
            <div class="play" onclick="toggleMusic('${suggestion.previewUrl}')">
              <img src="assets/icons/play-white.svg" alt="Play">
            </div>
          </div>
        `;
        
        return wrapper;
      }

      function addSuggestions(suggestions) {
        const chatContainer = document.querySelector('.chat');
        suggestions.forEach(suggestion => {
          const suggestionElement = createMessageSuggestion(suggestion);
          chatContainer.appendChild(suggestionElement);
        });
        scrollToLatest();
      }

      function addMessage(text, isUser = false) {
        const message = {
          text,
          isUser,
          timestamp: new Date()
        };
        
        state.messages.push(message);
        
        const chatContainer = document.querySelector('.chat');
        const messageElement = createMessageElement(text, isUser);
        
        // Insert before the last egg response if it exists
        const lastEggResponse = chatContainer.querySelector('.egg-response');
        if (lastEggResponse) {
          lastEggResponse.parentNode.insertBefore(messageElement, lastEggResponse);
        } else {
          chatContainer.appendChild(messageElement);
        }
        
        // Scroll to latest
        setTimeout(scrollToLatest, 100);
      }

      // Input handling
      function handleSend() {
        const input = document.querySelector('.input-text');
        const text = input.value.trim();
        
        if (text && !state.isProcessing) {
          // Clear input
          input.value = '';
          
          // Add user message
          addMessage(text, true);
          
          // Set processing state
          state.isProcessing = true;
          
          // Process the message
          processMessage(text);
        }
      }

      // Message processing
      async function processMessage(text) {
        const lowerText = text.toLowerCase();
        const commands = parseCommands(lowerText);
        
        try {
          state.isProcessing = true;
          addMessage("I'll help you with that");
          
          // Process each command in sequence
          for (const command of commands) {
            switch (command.type) {
              case 'weather':
                const weatherData = await getWeather();
                addEgg('weather', weatherData);
                break;
                
              case 'music':
                const searchTerm = command.query.trim();
                if (searchTerm) {
                  const musicResults = await searchMusicPreviews(searchTerm);
                  if (musicResults.length > 0) {
                    addEgg('music', {
                      result: musicResults[0],
                      suggestions: musicResults.slice(1, 3)
                    });
                  } else {
                    addMessage(`Sorry, I couldn't find music for "${searchTerm}"`);
                  }
                }
                break;
            }
          }
          
          if (commands.length === 0) {
            addMessage("I'm working on understanding that request");
          }
        } catch (error) {
          console.error('Error processing message:', error);
          addMessage("Sorry, there was an error processing your request");
        } finally {
          state.isProcessing = false;
        }
      }

      // Command parsing
      function parseCommands(text) {
        const commands = [];
        const parts = text.split(/\s+(?:and|&)\s+/); // Split on "and" or "&"
        
        parts.forEach(part => {
          // Check for weather
          if (part.includes('weather')) {
            commands.push({ type: 'weather' });
          }
          
          // Check for music/play commands
          const musicMatch = part.match(/(?:play|music)(.*)/i);
          if (musicMatch) {
            const query = musicMatch[1].trim();
            if (query) {
              commands.push({ type: 'music', query });
            }
          }
        });
        
        return commands;
      }

      // Enter key handling
      document.querySelector('.input-text').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleSend();
        }
      });

      // Time display
      function updateTime() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const formattedHours = hours % 12 || 12;
        const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
        
        // Update all time displays
        const timeDisplays = document.querySelectorAll('.text-wrapper, .time');
        timeDisplays.forEach(display => {
          display.textContent = `${formattedHours}:${formattedMinutes} ${ampm}`;
        });
      }
      
      // Initialize
      function scrollToBottom(container) {
        const scrollHeight = container.scrollHeight;
        const height = container.clientHeight;
        const maxScrollTop = scrollHeight - height;
        container.scrollTop = maxScrollTop;
      }

      // Initialization and setup
      function init() {
        // Update time initially and set interval
        updateTime();
        setInterval(updateTime, 60000);
        
        // Clear any example messages if needed
        const chat = document.querySelector('.chat');
        const timeWrapper = chat.querySelector('.text-wrapper');
        chat.innerHTML = '';
        chat.appendChild(timeWrapper);
        
        // Add welcome message
        addMessage("Welcome back, rsa");

        // Set up scroll padding based on egg tray height
        const updateEggTrayHeight = () => {
          const eggTray = document.querySelector('.egg-tray');
          const height = eggTray.offsetHeight;
          document.documentElement.style.setProperty('--egg-tray-height', `${height}px`);
        };

        // Initial height calculation
        updateEggTrayHeight();

        // Update height on window resize
        window.addEventListener('resize', updateEggTrayHeight);

        // Ensure proper scroll behavior
        const chatContainer = document.querySelector('.chat');
        chatContainer.addEventListener('scroll', () => {
          if (chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 10) {
            scrollToBottom(chatContainer);
          }
        });
      }
      
      // Start the app
      init();
    </script>
</body>
</html>